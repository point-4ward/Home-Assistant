#################################################
#                                               #
# This include is the notification engine, it   #
# takes input from the script that calls it and #
# builds the message accordingly with macros    #
# sending it to the correct media_player for    #
# the time of day                               #
#                                               #
#################################################


no_show: '{{ no_show }}'

who: >
  {% if tell == 'mf' %} notify.mf
  {% elif tell == 'ls' %} notify.ls
  {% elif tell == 'adults' %} notify.adults
  {% else %} {{ tell }} {% endif %}

message: >
  {%- macro greeting() -%}
    {% if now().hour < 12 and now().hour > 6 %}
      {% set greeting = ["Hello, " , "Good Morning, " , "Hey Guys! "] %}
    {% elif now().hour >= 12 and now().hour < 17 %}
      {% set greeting = ["Hey there! " , "Good afternoon, " , "Hi there, "] %}
    {% else %}
      {% set greeting = ["Hi, " , "Good evening, " , "Hello, "] %}
    {% endif %}
    {{ greeting|random }}
  {%- endmacro -%}

  {%- macro inform() -%}
    {{ ["I just want to inform you that ", "I just want to let you know that ",
      "You asked me to inform you when ", "I thought you'd like to know that "]|random }}
  {%- endmacro -%}

  {%- macro system_load() -%}
    Your system is running under heavy load!

    CPU:  {{states('sensor.processor_use')}}%

    Memory:  {{ states('sensor.memory_use_percent') }}%!
  {%- endmacro -%}

  {%- macro hdd_space() -%}
    Your harddrive is running out of Space! /dev/root: {{ states('sensor.disk_use_percent_') }}%!
  {%- endmacro -%}

  {%- macro moon() -%}
    {% if states('sensor.moon') == 'Full moon' %}
      There's a full moon tonight, check it out!
    {% else %}
      {{ outside_weather() }}
    {% endif %}
  {%- endmacro -%}

  {%- macro uv_index() -%}
    Outside, the UV index is {{ states('sensor.dark_sky_uv_index') }}
  {%- endmacro -%}

  {%- macro air_quality() -%}
    Outside, the current air quality is rated {{ states('sensor.us_air_pollution_level') }}
  {%- endmacro -%}

  {%- macro outside_weather() -%}
    Outside, it is going to be {{ states('sensor.dark_sky_minutely_summary') }}
  {%- endmacro -%}


  {# ************************************* #}
  {#  ******** Build the message ********  #}
  {# ************************************* #}


  {{- [greeting(), inform()]|random }}

  {%- if call_system_load == 1 %} {{- system_load() }} {% endif -%}

  {%- if call_hdd_space == 1 %} {{- hdd_space() }} {% endif -%}

  {{- message -}}

  {%- if call_power_on == 1 %}
    the system is back online
  {% endif -%}

  {%- if call_upgrade == 1 %}
    Update for Home Assistant is available.  Latest version is {{ states('sensor.latest_version') }}

    https://home-assistant.io/blog/
  {% endif -%}

  {%- if call_random_fact == 1 or is_state ('binary_sensor.random_binary_sensor' , 'on') %}
    Here is something interesting, {{- ([iss, moon, uv_index, air_quality, outside_weather]|random)() }}
  {% endif -%}
