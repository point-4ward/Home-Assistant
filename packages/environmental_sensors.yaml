#####################################################
#                                                   #
# This package contains the components and sensors  #
# I use to monitor the environmental factors        #
# where I live, the UI elements to display them     #
# and automations I use to fine tune the sensor     #
#                                                   #
#####################################################


homeassistant:
  customize:
    input_boolean.sunset_offset:
      hidden: true
      emulated_hue_hidden: true
    
    sensor.dark_outside:
      icon: mdi:theme-light-dark

    sensor.bad_weather:
      icon: mdi:weather-snowy-rainy


sun:


sensor:
  - platform: darksky
    api_key: !secret darksky_api_key
    units: auto
    update_interval:
      minutes: 60
    monitored_conditions:
      - summary
      - precip_type
      - precip_intensity
      - precip_probability
      - temperature
      - apparent_temperature
      - dew_point
      - wind_speed
      - wind_bearing
      - cloud_cover
      - humidity
      - pressure
      - visibility
      - ozone
      - minutely_summary
      - hourly_summary
      - daily_summary
      - temperature_max
      - temperature_min
      - apparent_temperature_max
      - apparent_temperature_min
      - precip_intensity_max

  - platform: template
    sensors:
      dark_outside:
        friendly_name: 'Dark outside'
        value_template: >-
          {% if (states.input_boolean.sunset_offset.state == 'on') %}true
          {% elif (states.sun.sun.attributes.elevation | int < 3) %}true
          {% elif ( (states.sun.sun.attributes.elevation | int < 4.5) and (states.sensor.dark_sky_cloud_coverage.state | int > 80)) %}true
          {% elif ( (states.sun.sun.attributes.elevation | int < 6.5) and (states.sensor.dark_sky_cloud_coverage.state | int > 85)) %}true
          {% elif (states.sensor.dark_sky_cloud_coverage.state | int > 90) %}true
          {% else %}false
          {% endif %}

      bad_weather:
        friendly_name: 'Bad weather'
        value_template: >-
          {% if (states.sensor.dark_sky_precip.state == "snow") %}snow
          {% elif ((states.sensor.dark_sky_daily_low_temperature.state | int < 4) and (states.sensor.dark_sky_dew_point.state | int < 6) and (states.sensor.dark_sky_wind_speed.state | int < 12) and (states.sensor.dark_sky_cloud_coverage.state | int < 20) and (states.sensor.dark_sky_humidity.state | int > 50)) %} frost
          {% elif (states.sensor.dark_sky_precip_intensity | int > 7) %} heavy_rain
          {% else %} clear
          {% endif %}


input_boolean:
  sunset_offset:


group:
  Environment:
    - sun.sun
    - sensor.dark_outside
    - sensor.bad_weather
    - sensor.dark_sky_apparent_temperature
    - sensor.dark_sky_cloud_coverage
    - sensor.dark_sky_daily_high_apparent_temperature
    - sensor.dark_sky_daily_high_temperature
    - sensor.dark_sky_daily_low_apparent_temperature
    - sensor.dark_sky_daily_low_temperature
    - sensor.dark_sky_daily_max_precip_intensity
    - sensor.dark_sky_daily_summary
    - sensor.dark_sky_dew_point
    - sensor.dark_sky_hourly_summary
    - sensor.dark_sky_humidity
    - sensor.dark_sky_minutely_summary
    - sensor.dark_sky_ozone
    - sensor.dark_sky_precip
    - sensor.dark_sky_precip_intensity
    - sensor.dark_sky_precip_probability
    - sensor.dark_sky_pressure
    - sensor.dark_sky_summary
    - sensor.dark_sky_temperature
    - sensor.dark_sky_visibility
    - sensor.dark_sky_wind_bearing
    - sensor.dark_sky_wind_speed


automation:
  - alias: 'sun going up'
    trigger:
      platform: sun
      event: sunrise
      offset: '+00:35:00'
    action:
      service: input_boolean.turn_off
      entity_id: input_boolean.sunset_offset

  - alias: 'sun going down'
    trigger:
      platform: sun
      event: sunset
      offset: '-00:35:00'
    action:
      service: input_boolean.turn_on
      entity_id: input_boolean.sunset_offset