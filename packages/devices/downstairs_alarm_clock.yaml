########################################################################
#                                                                      #
# This package creates an alarm clock which:                           #
# - allows you to select what music plays when it goes off             #
# - allows to select if one time alarm, or repeating                   #
#                                                                      #
#                                                                      #
#         ******This one is for the Living Room so******               #
#         ******  doesn't worry about the lights  ******               #
#                                                                      #
########################################################################


homeassistant:
  customize:
    sensor.downstairs_alarm_clock_time:
      friendly_name: 'Alarm Time'
      icon: mdi:alarm


input_number:
  downstairs_alarm_clock_hour:
    name: Hour
    icon: mdi:timer
    initial: 6
    min: 0
    max: 23
    step: 1

  downstairs_alarm_clock_minute:
    name: Minute
    icon: mdi:timer
    initial: 15
    min: 0
    max: 55
    step: 5

    
sensor:
  - platform: template
    sensors:
      downstairs_alarm_clock_hour:
        value_template: '{{ states.input_number.downstairs_alarm_clock_hour.state | int }}'

      downstairs_alarm_clock_minute:
        value_template: '{{ states.input_number.downstairs_alarm_clock_minute.state | int }}'

      downstairs_alarm_clock_time:
        value_template: >-
          {{ states.sensor.downstairs_alarm_clock_hour.state }}:
          {%- if states.sensor.downstairs_alarm_clock_minute.state|length == 1 -%}
            0
          {%- endif -%}
            {{ states.sensor.downstairs_alarm_clock_minute.state }}

      downstairs_alarm_clock_time_long:
        value_template: >-
          {% if states.sensor.downstairs_alarm_clock_hour.state|length == 1 -%}
            0
          {%- endif -%}
            {{ states.sensor.downstairs_alarm_clock_hour.state }}:
          {%- if states.sensor.downstairs_alarm_clock_minute.state|length == 1 -%}
            0
          {%- endif -%}
            {{ states.sensor.downstairs_alarm_clock_minute.state }}

            
#input_datetime:
#  downstairs_alarm_clock_time:
#    name: Alarm Time
#    has_date: false
#    has_time: true
#    initial: '06:15'


input_boolean:
  downstairs_alarm_clock_status:
    name: Activate Alarm
    icon: mdi:alarm-check
    initial: off

  downstairs_alarm_clock_repeat:
    name: Repeat?
    icon: mdi:autorenew


input_select:
  downstairs_alarm_sound:
    name: Music
    options:
      - Free Radio CW
      - Let Her Go
      - Nightswimming
    initial: Free Radio CW
    icon: mdi:music


group:
  downstairs_alarm_clock:
    control: hidden
    name: 'Alarm Clock'
    entities:
      - input_select.downstairs_alarm_sound
      - input_boolean.downstairs_alarm_clock_status
      - sensor.downstairs_alarm_clock_time
#      - input_datetime.downstairs_alarm_clock_time
      - input_number.downstairs_alarm_clock_hour
      - input_number.downstairs_alarm_clock_minute
      - input_boolean.downstairs_alarm_clock_repeat


automation:
  - alias: 'Downstairs play music'
    initial_state: on
    trigger:
      platform: template
      value_template: '{{ states.sensor.time.state == states.sensor.downstairs_alarm_clock_time_long.state }}'
      #'{{ states.sensor.time.state == states.input_datetime.downstairs_alarm_clock_time.state }}'
    condition:
      condition: state
      entity_id: input_boolean.downstairs_alarm_clock_status
      state: 'on'
    action:
      - service: script.downstairs_wake_up
      - condition: state
        entity_id: input_boolean.downstairs_alarm_clock_repeat
        state: 'off'
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.downstairs_alarm_clock_status


script:
  downstairs_wake_up:
    sequence:
      - service: media_player.volume_set
        data:
          entity_id: media_player.downstairs_group
          volume_level: '0.20'
      - service: media_player.play_media
        data_template:
          entity_id: media_player.downstairs_group
          media_content_id: !secret downstairs_wake_up_script
          media_content_type: 'audio/mp4'